
Project: 3DMaker (digitizer)

Purpose
- Interactive GUI tool to digitize points, lines and curves from PDF drawings and export them for downstream systems.
- Supports calibration (map PDF coords to real-world coordinates), multi-Z handling (elevation levels), 3D preview, and structured exports (CSV and SQL) with deterministic IDs.

High-level architecture
- Entry point: `main.py` (launches GUI / creates application object)
- Core app: `app.py` (main class contains UI + logic; split into mixins for calibration, points/lines, curves, deletion, utils)
- Interaction helpers: `points_lines.py` (points/lines interactions and selection dialogs), `curves.py` (curve creation helpers), `deletion.py` (deletion helpers), `calibration.py` (calibration helpers), `utils.py` (misc helpers)
- Exporter: `digitizer/exporter.py` (exports CSV and SQL; ensures DELETE ordering: Curves→Lines→Points and uses IDENTITY_INSERT in SQL blocks)
- Small test/verification: `smoke_test.py`

Dependencies
- Python 3.11+ (project used 3.13 in workspace)
- tkinter / ttk (UI)
- Pillow (PIL.Image, ImageTk) for image conversion / quick preview resize
- PyMuPDF (`fitz`) for high-quality PDF rasterization
- NumPy for numeric operations
- matplotlib (optional) for 3D view (mpl_toolkits.mplot3d + FigureCanvasTkAgg)
- standard libs: io, json, csv, datetime, shutil, os, configparser

Key design concepts & data model
- Deterministic ID allocation: `next_point_id()`, `next_line_id()`, `next_curve_id()` helpers in `app.py`. Optional `allocator` object supports deterministic counters and serialization.

- Primary in-memory data structures (lists of dicts):
	- `self.user_points`: list of point dicts
			fields: id, pdf_x, pdf_y, real_x, real_y, z (float), hidden (bool), just_duplicated (transient), text_id (canvas label id)
	- `self.lines`: list of line dicts
			fields: id, start_id, end_id, z (optional; otherwise averaged from endpoints), hidden, canvas_id, text_id
	- `self.curves`: list of curve dicts
			fields: id, start_id, end_id, arc_point_ids (ordered point ids), arc_points_pdf (list of pdf coords), arc_points_real (list of real coords + z), z_level, base_line_id, canvas_id, arc_point_marker_ids

- UI modes (radio buttons / mode_var):
	- `calibration` — pick reference PDF points and real coordinates
	- `coordinates` — add points by clicking
	- `lines` — create lines by clicking existing points (uses selection dialog when ambiguous)
	- `curves` — create curves via 3-point construction (circle from three points) and auto-generate arc points
	- `duplication` — duplicate entities across Z levels
	- `deletion` — click to delete
	- `identify` — show details of nearest entities

Main UI layout (in `app.py`) — right-hand control panel and central canvas
- Top menu bar: File (Open PDF, Open Project, Save Project, Close PDF, Export), Edit (Clear Points, Clear Calibration), View (Options...) — `open_display_options()` provides the display settings in a Toplevel.
- Left/main: PDF canvas (Tk Canvas) with scrollbars showing rasterized PDF image, plus canvas markers and labels.
- Right-hand `control_panel` with sections:
	- Zoom controls (Zoom In/Out, Fit Page, Zoom entry)
	- Calibration status + Level Name input
	- Point Collection panel: Mode RadioButtons, Level (elevation) entry, Points/Lines/Curves counter labels, Clear Points button
	- Editor tab: Treeviews (Points, Lines, Curves, RFID placeholder) for editing/selection
	- Editor context menu with actions: Toggle Hide/Show, Duplicate Point..., Insert Line..., Reassign References...
- Status bar at bottom showing hints
- Optional 3D view in a separate frame; initialized lazily when needed (matplotlib + mplot3d) and has a toolbar and theme checkbox.

Treeviews and Editor
- Editor treeviews (built in `_build_editor_tab`):
	- `points_tv`: columns: id, coords, refs (number referencing entities), z, hidden
	- `lines_tv`: columns: id, from, to, z, hidden
	- `curves_tv`: columns: id, pts (count), z, hidden
	- `rfid_tv`: placeholder columns: vertex, transponder, line, length
- Features:
	- Vertical scrollbars added for each treeview
	- `selectmode='extended'` to allow multi-select
	- Column-sorting (`_treeview_sort`) numeric-aware, toggles ascending/descending and shows arrow in header
	- Inline editing by double-click: `_on_treeview_double_click()` creates an Entry overlay, commits via `_commit_tree_edit()` which updates underlying data and handles Z conflict resolution
	- Programmatic inline edit: `_start_treeview_inline_edit(tree, iid, key)` — used after duplicate creation to focus the Z column

Editor-specific behaviors
- Duplicate-on-change Z conflict policy:
	- When changing a point's Z and there are other points at same XY with different Z, the app asks whether to create a duplicate point instead of modifying existing ones that might be referenced.
	- Duplicates are created via `_create_duplicate_point(orig_point, new_z)` which appends a new point with `just_duplicated=True` and sets GUI highlight tag `new`.
	- `just_duplicated` marks newly created duplicates until the user edits them — prevents silent mass changes.
- `editor_reassign_references()` prompts with a combobox listing candidate target point IDs (mouse-only) and then calls `_reassign_references(old_pid, new_pid)` to update lines/curves to target.
- `editor_insert_line()` opens a small modal with two comboboxes for Start/End point IDs. Combo boxes filter so start/end are on the same Z-level (mutual filtering). Uses `next_line_id()` to create new line.
- `editor_duplicate_point()` duplicates selected points (creates new points via `next_point_id()` and opens inline edit on Z column for last one)
- `editor_delete_selected()` deletes selected points/lines/curves (multi-select aware) and refreshes UI.

Canvas & Marker rendering
- `display_page()` uses PyMuPDF to render current page to pixmap, then convert to PIL Image and store `self._last_rendered_pil` for fast preview resizing
- `zoom_with_focus(zoom_factor, x, y)` does a fast preview by resizing cached PIL image for wheel events and schedules `_do_full_zoom_render()` after 250ms debounce to perform a full high-quality rasterization
- `redraw_markers()` clears and recreates all canvas items for: calibration markers, user point markers, point labels, user lines, line labels, curves and arc markers
	- Robust label handling: always recreate text items and ensure font size >= 1 to avoid disappearing when sliders decreased
- Canvas element tags used: `user_point`, `point_label`, `user_line`, `line_label`, `user_curve`, `arc_point`, `calibration_point` — used for bulk deletion and z-ordering

3D view
- Lazy initialization in `_init_3d_canvas()` using matplotlib TkAgg and `Axes3D`.
- `update_3d_plot()` builds 3D scatter for points and line/curve plots using `self.user_points`, `self.lines`, `self.curves` and respects `hidden` flags. Mirrors Y by negating real_y for 3D orientation.
- 3D preferences: `_3d_point_size`, `_3d_point_color`, `_3d_line_color`, `_3d_curve_color`, `_3d_theme`, `_3d_show_grid`, `_3d_elev`, `_3d_azim`

Project persistence (Save/Open)
- `save_project()` writes a JSON-like `.dig` file containing:
	- `pdf_path`, `calibration_pdf_points`, `calibration_real_points`, `transformation_matrix`, `points`, `lines`, `curves`, `zoom_level`, `last_mode`, `display` (colors/sizes), optional `id_counters` if allocator
- `open_project()` loads a project, migrates via `migrate_project` helper if present, restores data and display preferences, updates UI and `self._last_rendered_pil` by calling `display_page()`

Export
- `export_data()` writes three CSV files (points, lines, curves) and a SQL script with:
	- delete statements at the top (order: Curves, Lines, Points) to clear old data
	- inserts for Points (Visualization_Coordinate), Lines (Visualization_Edge), Curves (Visualization_Curve) using IDENTITY_INSERT toggles
- During export, `curve.arc_point_ids` are normalized to `total_positions` (interior+2) and the exporter will create missing points via `find_or_create_point()` using `next_point_id()`.

Other features, helpers and behaviors
- Calibrations: map PDF coords -> real coords using `transformation_matrix`; `calibration.py` provides helper functions and UI checks
- Identify mode: `find_items_near(pdf_x, pdf_y)` returns nearby points/lines/curves and entry shows details
- Deletion helper: `delete_point(p)`, `delete_line(l)`, `delete_curve(c)` manage removal safely
- RFID Treeview placeholder available for future data binding
- `open_display_options()` (View→Options) opens a Toplevel with color choosers and sliders. Display settings are stored in project file under `display` and restored when opening project

Keyboard & Mouse
- Shortcuts: Ctrl+Z (zoom in), Ctrl+X (zoom out), Delete (delete selected)
- Mouse: left-click behavior depends on mode; right-drag pans
- Wheel: zoom with focus; fast preview resizing then debounce final render

Important methods and functions (map to files)
- app.py
	- build_ui() — constructs main UI and menus
	- _build_editor_tab(parent) — creates Points/Lines/Curves/RFID treeviews and editor menu
	- display_page() — full PDF render, create PhotoImage, place canvas image
	- zoom_with_focus(zoom_factor, x, y) — preview + schedule final render
	- _do_full_zoom_render() — perform final display_page(), recenter scroll
	- redraw_markers() — rebuilds canvas items
	- _treeview_sort(tree, column) — column sort helper
	- _on_treeview_double_click, _start_treeview_inline_edit, _commit_tree_edit — inline editing flow
	- editor_insert_line(), editor_duplicate_point(), editor_reassign_references(), editor_delete_selected()
	- _create_duplicate_point(orig_point, z_value) — create duplicate and return id
	- next_point_id(), next_line_id(), next_curve_id() — id alloc helpers
	- open_display_options() — Toplevel for display colors/sizes
	- save_project(), open_project(), export_data()
- points_lines.py
	- handle_coordinates_click(canvas_x, canvas_y, pdf_x, pdf_y) — create a point, marker and label
	- handle_lines_click(canvas_x, canvas_y) — point selection for line creation (supports listbox dialog)
	- show_point_selection_dialog(candidates) — modal listbox for selecting among colliding points
	- update_points_label(), update_lines_label(), update_curves_label() — UI counters
- curves.py
	- handle_curves_click(canvas_x, canvas_y) — curve creation using three clicks, interior point generation, optional base line creation
	- circle_from_three_points(p1,p2,p3) — math helper
- digitizer/exporter.py — CSV/SQL generation logic

Behavioral edge-cases & design decisions to replicate
- Z-conflict resolution: editing Z of a point that shares XY with differently-z'ed point(s) will not silently change other references; user is offered to create a duplicate instead.
- Duplicate-on-change: new duplicates are highlighted (`just_duplicated` + treeview `new` tag) and user can explicitly reassign references.
- Inline editing does not allow editing ID or points-count cell (`pts`) in curves list.
- Display options are persisted but the UI is created lazily (Options window), so code must defensively handle missing swatch widgets (check `hasattr` before adjusting swatch backgrounds).
- Zoom performance: use cached PIL image for quick preview on wheel; schedule expensive PyMuPDF rasterization after a short debounce period (250ms) to avoid repeated long renders during fast wheel events.

Recreation guidance for an LLM
- Rebuild the main app class in `app.py` with the same high-level responsibilities.
- Model the in-memory data exactly as lists of dicts with the fields above so export and reassign logic is straightforward.
- Implement deterministic `next_*` helpers and allow swapping in an optional `allocator` object for persisted counters.
- Provide robust UI defensive checks (many try/except blocks) so missing optional subsystems (matplotlib, PyMuPDF) do not crash the app.
- Implement editor treeviews with inline editing overlays and a small context menu that selects the clicked row before performing actions.
- Recreate the export logic carefully: ensure SQL file contains deletes for Curves then Lines then Points and correct insertion of identity values.

Conventions and small implementation notes
- All numeric Z values are floats; comparisons often use small tolerance (1e-9) when comparing equality.
- When creating a new line/curve, immediately call `redraw_markers()` and `refresh_editor_lists()` to keep canvas and editor synced.
- Use `self.master.after(250, ...)` for debounce scheduling; cancel previous job if new wheel events occur.
- Label font sizes must be clamped `>= 1` to avoid invisible text.
- Treeview sorting: convert cell values to int/float when possible, else lexicographically.

Files to reproduce (minimum):
- `main.py` (bootstrap/launch)
- `app.py` (main class and UI) — largest file, contains most methods listed above
- `points_lines.py` (points/lines handlers and dialogs)
- `curves.py` (curve helpers)
- `digitizer/exporter.py` (export generation)
- `smoke_test.py` (basic run/test harness)

If you want, I can also generate a concise, runnable skeleton (files + minimal implementations) from this prompt for testing. Save this `prompt.txt` next to the project root as the canonical spec for reproduction.

